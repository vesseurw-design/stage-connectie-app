<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Stage Connectie App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50">
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Admin Portal</h1>
                <p class="text-sm text-gray-600">StageConnectie</p>
            </div>
            <div class="flex gap-4">
                <a href="admin-students-v2.html"
                    class="px-4 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg transition font-medium">
                    Studenten Beheer
                </a>
                <a href="admin-companies.html"
                    class="px-4 py-2 bg-purple-50 text-purple-600 hover:bg-purple-100 rounded-lg transition font-medium">
                    Bedrijven Beheer
                </a>
                <a href="admin-begeleiders-v3.html"
                    class="px-4 py-2 bg-green-50 text-green-600 hover:bg-green-100 rounded-lg transition font-medium">
                    Begeleiders Beheer
                </a>
                <a href="admin-branches.html"
                    class="px-4 py-2 bg-orange-50 text-orange-600 hover:bg-orange-100 rounded-lg transition font-medium">
                    Branches
                </a>
                <button onclick="handleLogout()"
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                    Uitloggen
                </button>
            </div>
        </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">Aanwezig Vandaag</h3>
                <p class="text-3xl font-bold text-green-600 mt-2" id="stat-present">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">Afwezig</h3>
                <p class="text-3xl font-bold text-red-600 mt-2" id="stat-absent">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">Ziek</h3>
                <p class="text-3xl font-bold text-orange-500 mt-2" id="stat-sick">-</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">Te Laat</h3>
                <p class="text-3xl font-bold text-yellow-500 mt-2" id="stat-late">-</p>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap gap-4 items-end">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Datum</label><input type="date"
                    id="filter-date" class="px-3 py-2 border rounded-lg text-sm"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Bedrijf</label><select id="filter-company"
                    class="px-3 py-2 border rounded-lg text-sm min-w-[200px]">
                    <option value="">Alle bedrijven</option>
                </select></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Status</label><select id="filter-status"
                    class="px-3 py-2 border rounded-lg text-sm">
                    <option value="">Alle status</option>
                    <option value="present">Aanwezig</option>
                    <option value="absent">Afwezig</option>
                    <option value="sick">Ziek</option>
                    <option value="late">Te laat</option>
                </select></div>
        </div>
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Student</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Bedrijf</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Details</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // INLINE SCRIPT - No caching issues!
        const SUPABASE_URL = 'https://ninkkvffhvkxrrxddgrz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbmtrdmZmaHZreHJyeGRkZ3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTc2NTcsImV4cCI6MjA3OTU3MzY1N30.Kq6jojYu5Hopmtzmdqwc9dwUyIZBOm7c27N-OCv1aCM';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allAttendance = [];
        let companies = [];
        let students = [];
        let currentUser = null;

        // Logout function
        function handleLogout() {
            console.log('üö™ Logging out...');
            db.auth.signOut();
            localStorage.removeItem('stageconnect_admin_session');
            localStorage.removeItem('admin_email');
            localStorage.removeItem('admin_name');
            localStorage.removeItem('auth_user_id');
            window.location.href = 'admin-login.html';
        }

        async function checkAuth() {
            console.log('üîê Checking authentication...');
            const { data: { session }, error } = await db.auth.getSession();

            if (error) {
                console.error('‚ùå Auth error:', error);
                window.location.href = 'admin-login.html';
                return false;
            }

            if (!session) {
                console.log('‚ö†Ô∏è No active session, redirecting to login...');
                window.location.href = 'admin-login.html';
                return false;
            }

            currentUser = session.user;
            console.log('‚úÖ Authenticated as:', currentUser.email);
            console.log('üë§ User role:', currentUser.user_metadata?.role);

            if (currentUser.user_metadata?.role !== 'admin') {
                console.error('‚ùå User is not an admin');
                alert('Je hebt geen admin rechten!');
                window.location.href = 'admin-login.html';
                return false;
            }

            return true;
        }

        async function init() {
            console.log('üöÄ Initializing admin dashboard...');

            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return;
            }

            await Promise.all([
                loadCompanies(),
                loadStudents(),
                loadAttendance()
            ]);
            setupRealtimeSubscription();
            setupFilters();
            updateDashboard();
        }

        async function loadCompanies() {
            console.log('üì¶ Loading companies...');
            const { data, error } = await db
                .from('Bedrijven')
                .select('*');

            if (error) {
                console.error('‚ùå Error loading companies:', error);
                return;
            }

            companies = data || [];
            console.log('‚úÖ Loaded companies:', companies.length);

            const filterCompany = document.getElementById('filter-company');
            companies.forEach(company => {
                filterCompany.innerHTML += `<option value="${company.id}">${company.company_name}</option>`;
            });
        }

        async function loadStudents() {
            console.log('üë• Loading students...');
            const { data, error } = await db
                .from('Students')
                .select('*');

            if (error) {
                console.error('‚ùå Error loading students:', error);
                return;
            }

            students = data || [];
            console.log('‚úÖ Loaded students:', students.length, students);
        }

        async function loadAttendance() {
            console.log('üìä Loading attendance...');
            const { data, error } = await db
                .from('Attendance')
                .select('*')
                .order('date', { ascending: false });

            if (error) {
                console.error('‚ùå Error loading attendance:', error);
                return;
            }

            allAttendance = data || [];
            console.log('‚úÖ Loaded attendance records:', allAttendance.length, allAttendance);
        }

        function setupRealtimeSubscription() {
            db
                .channel('public:Attendance')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'Attendance' },
                    (payload) => {
                        console.log('üîÑ Real-time update:', payload);
                        loadAttendance().then(updateDashboard);
                    }
                )
                .subscribe();
        }

        function setupFilters() {
            ['filter-date', 'filter-company', 'filter-status'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateDashboard);
            });

            document.getElementById('filter-date').valueAsDate = new Date();
        }

        function updateDashboard() {
            const dateFilter = document.getElementById('filter-date').value;
            const companyFilter = document.getElementById('filter-company').value;
            const statusFilter = document.getElementById('filter-status').value;

            console.log('üîç Filtering with:', { dateFilter, companyFilter, statusFilter });

            let filtered = allAttendance;

            if (dateFilter) {
                filtered = filtered.filter(a => a.date === dateFilter);
            }

            if (companyFilter) {
                filtered = filtered.filter(a => a.employer_id === companyFilter);
            }

            if (statusFilter) {
                filtered = filtered.filter(a => a.status === statusFilter);
            }

            console.log('üìã Filtered attendance:', filtered.length, filtered);

            updateStats(filtered);
            renderTable(filtered);
        }

        function updateStats(attendance) {
            const stats = {
                present: attendance.filter(a => a.status === 'present').length,
                absent: attendance.filter(a => a.status === 'absent').length,
                sick: attendance.filter(a => a.status === 'sick').length,
                late: attendance.filter(a => a.status === 'late').length
            };

            document.getElementById('stat-present').textContent = stats.present;
            document.getElementById('stat-absent').textContent = stats.absent;
            document.getElementById('stat-sick').textContent = stats.sick;
            document.getElementById('stat-late').textContent = stats.late;
        }

        function renderTable(attendance) {
            const tbody = document.getElementById('attendance-table-body');
            tbody.innerHTML = '';

            console.log('üé® Rendering table with', attendance.length, 'records');

            if (attendance.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            Geen aanwezigheidsgegevens gevonden voor de geselecteerde filters
                        </td>
                    </tr>
                `;
                return;
            }

            attendance.forEach(record => {
                console.log('üìù Processing record:', record);
                console.log('üîç Looking for student with id:', record.student_id);

                const student = students.find(s => s.id === record.student_id);
                console.log('üë§ Found student:', student);

                const company = companies.find(c => c.id === record.employer_id);
                console.log('üè¢ Found company:', company);

                const statusClasses = {
                    'present': 'bg-green-100 text-green-800',
                    'absent': 'bg-red-100 text-red-800',
                    'sick': 'bg-orange-100 text-orange-800',
                    'late': 'bg-yellow-100 text-yellow-800'
                };

                const statusLabels = {
                    'present': 'Aanwezig',
                    'absent': 'Afwezig',
                    'sick': 'Ziek',
                    'late': `Te laat (${record.minutes_late}m)`
                };

                const studentName = student ? student.name : `ID: ${record.student_id}`;
                const companyName = company ? company.company_name : 'Onbekend';

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${studentName}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${companyName}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${record.date}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses[record.status]}">
                                ${statusLabels[record.status]}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${record.status === 'late' ? `${record.minutes_late} minuten` : '-'}
                        </td>
                    </tr>
                `;

                tbody.innerHTML += row;
            });
        }

        // Initialize on page load
        init();
    </script>
</body>

</html>